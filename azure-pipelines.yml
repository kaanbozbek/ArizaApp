trigger:
 - master

pool:
  vmImage: 'WindowsPool'

steps:
- task: replacetokens@5
  inputs:
    targetFiles: '**/appsettings.json'
    encoding: 'auto'
    writeBOM: true
    actionOnMissing: 'warn'
    keepToken: false
    tokenPrefix: '#{'
    tokenSuffix: '}#'
    actionOnNoFiles: 'fail'

- task: UseDotNet@2
  displayName: 'Use .Net Core SDK 5.0'
  inputs:
    packageType: sdk
    version: 5.0.x
    installationPath: $(Agent.ToolsDirectory)/dotnet

- script: dotnet build --configuration Release
  displayName: Building .Net code
- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'

- script: dotnet publish WebApp --configuration Release --output publish/
  displayName: Packing application WebApp

- task: CopyFiles@2
  displayName: Copy packed application WebApp to output
  inputs:
    contents: |
      WebApp/publish/**
      !**/appsettings.Development.json
    targetFolder: '$(Build.ArtifactStagingDirectory)/'
    flattenFolders: true

- task: PublishBuildArtifacts@1
  displayName: Publishing artifacts
